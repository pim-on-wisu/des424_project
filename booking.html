<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Book Parking | Park with Me</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    /* Header */
    header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 20px 24px;
      margin-bottom: 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    .back-btn {
      background: #f3f4f6;
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 10px;
      font-size: 20px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .back-btn:hover {
      background: #e5e7eb;
      transform: translateX(-2px);
    }

    .location-info h1 {
      font-size: 24px;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 4px;
    }

    .location-subtitle {
      font-size: 14px;
      color: #6b7280;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .location-subtitle::before {
      content: '';
      width: 4px;
      height: 4px;
      background: #6b7280;
      border-radius: 50%;
    }

    /* Main Content */
    .booking-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 32px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .section-header h2 {
      font-size: 20px;
      font-weight: 600;
      color: #1f2937;
    }

    .legend {
      display: flex;
      gap: 16px;
      font-size: 13px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .legend-box {
      width: 16px;
      height: 16px;
      border-radius: 4px;
    }

    .legend-box.available { background: #10b981; }
    .legend-box.occupied { background: #ef4444; }
    .legend-box.selected { background: #3b82f6; }

    /* Parking Layout */
    .parking-lot {
      display: grid;
      grid-template-columns: repeat(10, 1fr);
      gap: 12px;
      margin-bottom: 32px;
      perspective: 1000px;
    }

    .parking-space {
      aspect-ratio: 1;
      background: #10b981;
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      border: 3px solid transparent;
    }

    .parking-space::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: 6px;
      border: 2px dashed rgba(255, 255, 255, 0.4);
    }

    .space-number {
      font-size: 16px;
      font-weight: 700;
      color: white;
      margin-bottom: 4px;
    }

    .space-icon {
      font-size: 24px;
    }

    .parking-space.available:hover {
      transform: translateY(-4px) scale(1.05);
      box-shadow: 0 8px 16px rgba(16, 185, 129, 0.3);
    }

    .parking-space.occupied {
      background: #ef4444;
      cursor: not-allowed;
      opacity: 0.7;
    }

    .parking-space.selected {
      background: #3b82f6;
      transform: translateY(-4px) scale(1.05);
      box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
      border-color: #1d4ed8;
    }

    /* Booking Details */
    .booking-details {
      background: #f9fafb;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      display: none;
    }

    .booking-details.active {
      display: block;
      animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .detail-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 16px;
      font-size: 15px;
    }

    .detail-label {
      color: #6b7280;
      font-weight: 500;
    }

    .detail-value {
      color: #1f2937;
      font-weight: 600;
    }

    .time-selector {
      margin-top: 16px;
    }

    .time-selector label {
      display: block;
      font-weight: 600;
      color: #374151;
      margin-bottom: 8px;
    }

    .time-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
      gap: 8px;
    }

    .time-btn {
      padding: 12px;
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .time-btn:hover {
      border-color: #3b82f6;
      background: #eff6ff;
    }

    .time-btn.active {
      background: #3b82f6;
      color: white;
      border-color: #3b82f6;
    }

    .price-display {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 16px;
      border-radius: 10px;
      margin-top: 16px;
      text-align: center;
    }

    .price-label {
      font-size: 14px;
      opacity: 0.9;
      margin-bottom: 4px;
    }

    .price-amount {
      font-size: 32px;
      font-weight: 700;
    }

    /* Confirm Button */
    .confirm-btn {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .confirm-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
    }

    .confirm-btn:disabled {
      background: #d1d5db;
      cursor: not-allowed;
      box-shadow: none;
    }

    /* Success Modal */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal.active {
      display: flex;
      animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal-content {
      background: white;
      border-radius: 16px;
      padding: 32px;
      max-width: 400px;
      width: 100%;
      text-align: center;
      animation: scaleIn 0.3s ease-out;
    }

    @keyframes scaleIn {
      from {
        opacity: 0;
        transform: scale(0.9);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .success-icon {
      font-size: 64px;
      margin-bottom: 16px;
    }

    .modal-content h3 {
      font-size: 24px;
      margin-bottom: 8px;
      color: #1f2937;
    }

    .modal-content p {
      color: #6b7280;
      margin-bottom: 24px;
    }

    .modal-btn {
      padding: 12px 32px;
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .modal-btn:hover {
      background: #2563eb;
    }

    @media (max-width: 768px) {
      .parking-lot {
        grid-template-columns: repeat(5, 1fr);
        gap: 8px;
      }

      .booking-card {
        padding: 20px;
      }

      .space-number {
        font-size: 12px;
      }

      .space-icon {
        font-size: 18px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <button class="back-btn" onclick="goBack()">‚Üê</button>
      <div class="location-info">
        <h1 id="placeName">SIIT faculty Parking</h1>
        <div class="location-subtitle">üìç Khlong Nueng, Khlong Luang District, Pathum Thani 12120</div>
      </div>
      <div style="width:40px;"></div>
    </header>

    <div class="booking-card">
      <div class="section-header">
        <h2>Select Your Parking Space</h2>
        <div class="legend">
          <div class="legend-item">
            <div class="legend-box available"></div>
            <span>Available</span>
          </div>
          <div class="legend-item">
            <div class="legend-box occupied"></div>
            <span>Occupied</span>
          </div>
          <div class="legend-item">
            <div class="legend-box selected"></div>
            <span>Selected</span>
          </div>
        </div>
      </div>

      <div id="parkingLot" class="parking-lot"></div>

      <div id="bookingDetails" class="booking-details">
        <div class="detail-row">
          <span class="detail-label">Selected Space:</span>
          <span class="detail-value" id="selectedSpace">-</span>
        </div>
        
<div class="time-selector">
  <label>Start Time:</label>
  <input type="datetime-local" id="startTime" class="time-input">

  <label style="margin-top:12px;">Duration:</label>
  <div class="time-buttons">
    <button class="time-btn" data-hours="1">1 hr</button>
    <button class="time-btn" data-hours="2">2 hrs</button>
    <button class="time-btn" data-hours="3">3 hrs</button>
    <button class="time-btn" data-hours="4">4 hrs</button>
    <button class="time-btn" data-hours="6">6 hrs</button>
    <button class="time-btn" data-hours="12">12 hrs</button>
  </div>
</div>

<div class="price-display" id="priceDisplay" style="display: none;">
  <div class="price-label">Total Price</div>
  <div class="price-amount" id="priceAmount">$0</div>
  <div id="timeSummary" style="margin-top:10px;font-size:14px;color:#fff;"></div>
</div>


      <button id="confirmBtn" class="confirm-btn" disabled>Confirm Booking</button>
    </div>
  </div>

  <div id="successModal" class="modal">
    <div class="modal-content">
      <div class="success-icon">‚úÖ</div>
      <h3>Booking Confirmed!</h3>
      <p id="confirmationMessage"></p>
      <button class="modal-btn" onclick="closeModal()">Done</button>
    </div>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const place = decodeURIComponent(params.get("place") || "SIIT faculty Parking");
    document.getElementById("placeName").textContent = place;

    const parkingLot = document.getElementById("parkingLot");
    const confirmBtn = document.getElementById("confirmBtn");
    const bookingDetails = document.getElementById("bookingDetails");
    const priceDisplay = document.getElementById("priceDisplay");
    const priceAmount = document.getElementById("priceAmount");

    let selectedSlot = null;
    let selectedHours = null;
    const pricePerHour = 20;

    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡πà‡∏≠‡∏á‡∏à‡∏≠‡∏î‡∏à‡∏≤‡∏Å API ‡∏à‡∏£‡∏¥‡∏á
async function loadParkingSlots() {
  try {
    const response = await fetch("https://555hmixbzg.execute-api.ap-southeast-1.amazonaws.com/dev/getParkingStatus");
    const result = await response.json();

    // ‚úÖ parse JSON ‡πÉ‡∏ô body (‡πÄ‡∏û‡∏£‡∏≤‡∏∞ API Gateway ‡∏™‡πà‡∏á‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô string)
    const data = typeof result.body === "string" ? JSON.parse(result.body) : result;

    parkingLot.innerHTML = ""; // ‡∏•‡πâ‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô render ‡πÉ‡∏´‡∏°‡πà

    data.forEach(space => {
      const isOccupied = space.status !== "free";
      const div = document.createElement("div");
      div.className = `parking-space ${isOccupied ? 'occupied' : 'available'}`;
      div.innerHTML = `
        <div class="space-number">${space.slot_id.replace('siit_a1_', 'A').toUpperCase()}</div>
        <div class="space-icon">${isOccupied ? 'üöó' : 'üìç'}</div>
      `;

      if (!isOccupied) {
        div.addEventListener("click", () => selectSpace(space.slot_id, div));
      }

      parkingLot.appendChild(div);
    });

  } catch (error) {
    console.error("Error loading parking data:", error);
    alert("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏î‡πÑ‡∏î‡πâ ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á");
  }
}

// üîÑ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°
window.addEventListener("DOMContentLoaded", loadParkingSlots);


    // Render parking spaces
    spaces.forEach(space => {
      const div = document.createElement("div");
      div.className = `parking-space ${space.occupied ? 'occupied' : 'available'}`;
      div.innerHTML = `
        <div class="space-number">${space.id}</div>
        <div class="space-icon">${space.occupied ? 'üöó' : 'üìç'}</div>
      `;

      if (!space.occupied) {
        div.addEventListener("click", () => selectSpace(space.id, div));
      }

      parkingLot.appendChild(div);
    });

    function selectSpace(spaceId, element) {
      document.querySelectorAll(".parking-space").forEach(s => s.classList.remove("selected"));
      element.classList.add("selected");
      selectedSlot = spaceId;
      document.getElementById("selectedSpace").textContent = spaceId;
      bookingDetails.classList.add("active");
      updateConfirmButton();
    }

    // Time selection
    document.querySelectorAll(".time-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".time-btn").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        selectedHours = parseInt(btn.dataset.hours);
        updatePrice();
        updateConfirmButton();
      });
    });

    function updatePrice() {
      if (selectedHours) {
        const total = pricePerHour * selectedHours;
        priceAmount.textContent = `${total}‡∏ø`;
        priceDisplay.style.display = "block";
      }
    }

    function updateConfirmButton() {
      confirmBtn.disabled = !(selectedSlot && selectedHours);
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô
    function checkLoginStatus() {
      const isLoggedIn = localStorage.getItem("isLoggedIn");

      if (isLoggedIn === "true") {
        return true;
      }
      return false;
    }

    // confirmBtn.addEventListener("click", () => {
    //   if (checkLoginStatus()) {
    //     // ‡∏ñ‡πâ‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß
    //     const total = pricePerHour * selectedHours;
    //     document.getElementById("confirmationMessage").textContent = 
    //       `Space ${selectedSlot} is reserved for ${selectedHours} hour${selectedHours > 1 ? 's' : ''} at ${place}. Total: ${total}‡∏ø`;
    //     document.getElementById("successModal").classList.add("active");
    //   } else {
    //     // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ login.html
    //     window.location.href = "login.html";
    //   }
    // });
    confirmBtn.addEventListener("click", async () => {
  if (!checkLoginStatus()) {
    window.location.href = "login.html";
    return;
  }

  const total = pricePerHour * selectedHours;
  const userId = localStorage.getItem("userId") || "guest";
  const startTime = new Date().toISOString();
  const endTime = new Date(Date.now() + selectedHours * 60 * 60 * 1000).toISOString();

  // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á‡πÑ‡∏õ Lambda ‡∏ú‡πà‡∏≤‡∏ô API Gateway
  const bookingData = {
    slot_id: selectedSlot,
    user_id: userId,
    start_time: startTime,
    end_time: endTime,
  };

  try {
    const response = await fetch("https://555hmixbzg.execute-api.ap-southeast-1.amazonaws.com/dev/bookParking", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(bookingData),
    });

    const result = await response.json();
    console.log("Booking API Response:", result);

    if (response.ok) {
      document.getElementById("confirmationMessage").textContent =
        `Space ${selectedSlot} booked successfully for ${selectedHours} hour${selectedHours > 1 ? 's' : ''} at ${place}. Total: ${total}‡∏ø`;
      document.getElementById("successModal").classList.add("active");
    } else {
      alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á: " + (result.message || "Unknown error"));
    }
  } catch (error) {
    console.error("Booking error:", error);
    alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡πÑ‡∏î‡πâ ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á");
  }
});

    function closeModal() {
      document.getElementById("successModal").classList.remove("active");
      setTimeout(() => {
        window.location.href = "index.html";
      }, 300);
    }

    function goBack() {
      window.location.href = "index.html";
    }
  </script>
</body>
</html>
